///$tab Main
SET ThousandSep=' ';
SET DecimalSep=',';
SET MoneyThousandSep=' ';
SET MoneyDecimalSep=',';
SET MoneyFormat='# ##0,00 €;-# ##0,00 €';
SET TimeFormat='hh:mm:ss';
SET DateFormat='DD/MM/YYYY';
SET TimestampFormat='DD/MM/YYYY hh:mm:ss[.fff]';
SET FirstWeekDay=0;
SET BrokenWeeks=0;
SET ReferenceDay=4;
SET FirstMonthOfYear=1;
SET CollationLocale='fr-FR';
SET CreateSearchIndexOnReload=1;
SET MonthNames='janv.;févr.;mars;avr.;mai;juin;juil.;août;sept.;oct.;nov.;déc.';
SET LongMonthNames='janvier;février;mars;avril;mai;juin;juillet;août;septembre;octobre;novembre;décembre';
SET DayNames='lun.;mar.;mer.;jeu.;ven.;sam.;dim.';
SET LongDayNames='lundi;mardi;mercredi;jeudi;vendredi;samedi;dimanche';
SET NumericalAbbreviation='3:k;6:M;9:G;12:T;15:P;18:E;21:Z;24:Y;-3:m;-6:μ;-9:n;-12:p;-15:f;-18:a;-21:z;-24:y';


///$tab Section générée automatiquement
///$autogenerated
Set dataManagerTables = '','Table_traitements_dossier_par_partenaire_et_analyste','Etats_Dossiers','Natures_Biens','Actions_Commerciales','Referentiel_Analyste_Snowflake','Referentiel_apporteurs_dossier_credit','Referentiel_VDN','Referentiel_Geo','Appels_Telephoniques_Sofinco','Appels_Telephoniques_VDN';
//This block renames script tables from non generated section which conflict with the names of managed tables

For each name in $(dataManagerTables) 
    Let index = 0;
    Let currentName = name; 
    Let tableNumber = TableNumber(name); 
    Let matches = 0; 
    Do while not IsNull(tableNumber) or (index > 0 and matches > 0)
        index = index + 1; 
        currentName = name & '-' & index; 
        tableNumber = TableNumber(currentName) 
        matches = Match('$(currentName)', $(dataManagerTables));
    Loop 
    If index > 0 then 
            Rename Table '$(name)' to '$(currentName)'; 
    EndIf; 
Next; 
Set dataManagerTables = ;


Unqualify *;

[Table_traitements_dossier_par_partenaire_et_analyste]:
LOAD
	[Date MAJ Dossier],
	[N° de contrat],
	[Date de création Dossier],
	[Id de l'apporteur],
	[Barême remboursement prêt],
	[Canal arrivée du client],
	[Type de produit],
	[Type de sous produit],
	[Nature de bien],
	[Code action commerciale],
	[Etat du dossier],
	[Matricule analyste (Sofinco)],
	[Top traitement par analyste (1=oui, 0=non)],
	[Top assurance emprunteur (1=oui, 0=non)],
	[Nb échéances du crédit],
	[Montant demandé par le client],
	[Délai entre saisi et acceptation par Sofinco],
	[Délai entre saisi et refus par Sofinco],
	[Délai entre saisi et annulé par le client],
	[Montant accordé au client],
	[Taux du crédit]
 FROM [lib://CACF_Data:DataFiles/Table_traitements_dossier_par_partenaire_et_analyste.qvd]
(qvd);

[Etats_Dossiers]:
LOAD
	[Etat du dossier],
	[Libellé de l'état du dossier]
 FROM [lib://CACF_Data:DataFiles/Etats_Dossiers.qvd]
(qvd);

[Natures_Biens]:
LOAD
	[Nature de bien],
	[Libellé Nature de bien]
 FROM [lib://CACF_Data:DataFiles/Natures_Biens.qvd]
(qvd);

[Actions_Commerciales]:
LOAD
	[Code action commerciale],
	[Libellé action commerciale],
	[Offre associée à l'action commerciale],
	[Famille de l'offre],
	[Support de l'offre],
	[Média de l'offre],
	[Cible de la campagne]
 FROM [lib://CACF_Data:DataFiles/Actions_Commerciales.qvd]
(qvd);

LIB CONNECT TO [CACF_Shared:Snowflake_sfseeurope-eu_demo91_2.snowflakecomputing.com];

[Referentiel_Analyste_Snowflake]:
LOAD
	[MATRICULE] AS [Matricule analyste (Sofinco)],
	[ANALYSTE_NOM] AS [Nom de l'analyste];
SELECT "MATRICULE",
	"ANALYSTE_NOM"
FROM "CALL_CENTER"."PUBLIC"."R_ANALYSTE";

[Referentiel_apporteurs_dossier_credit]:
LOAD
	[Id de l'apporteur],
	[Partenaire],
	[Code qualité apporteur(1=Mr 2=Mde 4=Personne morale/société)],
	[Raison sociale apporteur],
	[Bureau distributeur],
	[Code postal apporteur],
	[Statut collaborateur CACF (10=agrément non validé, 20=en activité, 30=radié)],
	[Code ID apporteur Père],
	[Libellé apporteur Père],
	left([Code postal apporteur],2) AS [Code Département],
	[Partenaire] AS [PARTENAIRE_SECURE]
 FROM [lib://CACF_Data:DataFiles/Referentiel_apporteurs_dossier_credit.qvd]
(qvd);

[Referentiel_VDN]:
LOAD
	[Numéro de VDN],
	[Libellé du VDN]
 FROM [lib://CACF_Data:DataFiles/Referentiel_VDN.qvd]
(qvd);

[Referentiel_Geo]:
LOAD
	[code_departement] AS [Code Département],
	[nom_departement] AS [Département],
	[nom_region] AS [Région]
 FROM [lib://CACF_Data:DataFiles/Referentiel_Geo.qvd]
(qvd);

[Appels_Telephoniques_Sofinco]:
LOAD
	Date(Date#([Date contact téléphonique], 'MM/DD/YYYY') ) AS [Date contact téléphonique],
	[Matricule analyste (Sofinco)] AS [Matricule Appels],
	[Nb appels pris],
	[Nb appels sortants],
	[Durée de connexion de l'analyste],
	[Temps passé en communication avec le client],
	[Temps passé sur le codage],
	[Durée de la sonnerie],
	[Temps passé en temps libre],
	[Temps passé sur une activité indeterminée],
	[Temps passé pour traiter les emails des clients],
	[Temps passé sur la codification],
	[Durée de la pause déjeuner],
	[Durée de la pause détente],
	[Temps passé en réunion],
	[Durée des pauses spécifiques],
	[Temps passé en formation],
	[Temps passé en mission],
	[Temps passé en délégation],
	[Temps passé pour le suivi avec le manager],
	[Temps passé pour suivi et acceptation dossier],
	[Temps passé sur le portefeuille],
	[Temps passé sur les appeles sortants],
	[Temps passé sur les redirections d'appel (appel dévié)],
	[Source]
 FROM [lib://CACF_Data:DataFiles/Appels_Telephoniques_Sofinco.qvd]
(qvd);

[Appels_Telephoniques_VDN]:
LOAD
	[Date contact téléphonique],
	[Numéro de VDN],
	[Tranche Horaire d'appel],
	[Nb appels pris (VDN)],
	[Nb appels abandonnés],
	[Nb appels dissuadés],
	[Nb appels déviés],
	[Nb appels entrants],
	[Nb appels abandonnés en moins de 5 secondes],
	[Nb appels abandonnés entre 5 et 10 secondes],
	[Nb appels abandonnés entre 10 et 15 secondes],
	[Nb appels abandonnés entre 15 et 20 secondes],
	[Nb appels offerts],
	[Temps total de communication],
	[Temps total d'attente avant abandon],
	[Nb appels pris en moins de 5 secondes],
	[Nb appels pris entre 5 et 10 secondes],
	[Nb appels pris entre 10 et 15 secondes],
	[Nb appels pris entre 15 et 20 secondes],
	[Nb appels pris entre 20 et 30 secondes],
	[Nb appels pris entre 30 et 40 secondes],
	[Nb appels pris entre 40 et 50 secondes],
	[Nb appels pris entre 50 et 70 secondes],
	[Nb appels pris entre 70 et 90 secondes],
	[Nb appels pris en plus de 90 secondes],
	[Nb appels abandonnés entre 20 et 30 secondes],
	[Nb appels abandonnés entre 30 et 40 secondes],
	[Nb appels abandonnés entre 40 et 50 secondes],
	[Nb appels abandonnés entre 50 et 70 secondes],
	[Nb appels abandonnés entre 70 et 90 secondes],
	[Nb appels abandonnés en plus de 90 secondes],
	[Source] AS [Source_VDN]
 FROM [lib://CACF_Data:DataFiles/Appels_Telephoniques_VDN.qvd]
(qvd);




[autoCalendar]: 
  DECLARE FIELD DEFINITION Tagged ('$date')
FIELDS
  Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),
  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter', '$cyclic'),
  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$yearquarter', '$qualified'),
  Dual('Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [_YearQuarter] Tagged ('$yearquarter', '$hidden', '$simplified'),
  Month($1) AS [Month] Tagged ('$month', '$cyclic'),
  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth', '$qualified'),
  Dual(Month($1), monthstart($1)) AS [_YearMonth] Tagged ('$axis', '$yearmonth', '$simplified', '$hidden'),
  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber', '$cyclic'),
  Date(Floor($1)) AS [Date] Tagged ('$axis', '$date', '$qualified'),
  Date(Floor($1), 'D') AS [_Date] Tagged ('$axis', '$date', '$hidden', '$simplified'),
  If (DayNumberOfYear($1) <= DayNumberOfYear(Today()), 1, 0) AS [InYTD] ,
  Year(Today())-Year($1) AS [YearsAgo] ,
  If (DayNumberOfQuarter($1) <= DayNumberOfQuarter(Today()),1,0) AS [InQTD] ,
  4*Year(Today())+Ceil(Month(Today())/3)-4*Year($1)-Ceil(Month($1)/3) AS [QuartersAgo] ,
  Ceil(Month(Today())/3)-Ceil(Month($1)/3) AS [QuarterRelNo] ,
  If(Day($1)<=Day(Today()),1,0) AS [InMTD] ,
  12*Year(Today())+Month(Today())-12*Year($1)-Month($1) AS [MonthsAgo] ,
  Month(Today())-Month($1) AS [MonthRelNo] ,
  If(WeekDay($1)<=WeekDay(Today()),1,0) AS [InWTD] ,
  (WeekStart(Today())-WeekStart($1))/7 AS [WeeksAgo] ,
  Week(Today())-Week($1) AS [WeekRelNo] ;

DERIVE FIELDS FROM FIELDS [Date MAJ Dossier], [Date de création Dossier], [Date contact téléphonique] USING [autoCalendar] ;
///$tab Exclusions
//Search Exclude PARTENAIRE_SECURE;
///$tab Securite
/*
section access;

load * inline [
ACCESS, USER.EMAIL, PARTENAIRE_SECURE
ADMIN, rfe@qlik.com, ALL
USER, johnbrifford.qlik@gmail.com, AG2R
USER, vincentvega.qlik@gmail.com, ALL
USER, patrickjouvet.qlik@gmail.com, ALL
];

// load * inline [
// ACCESS, USER.EMAIL, REGION_SECURE, SITE_SECURE
// ADMIN, rfe@qlik.com, ALL
// USER, johnbrifford.qlik@gmail.com, PARIS OUEST
// USER, johnbrifford.qlik@gmail.com, ,LES ULIS
// ];

section application;